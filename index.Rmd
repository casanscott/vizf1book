--- 
title: "Visualizing Formula 1 Data in R"
author: "Casan Scott, Ph.D."
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
  word_document: default
  word_document2: default
  pdf_document: default
documentclass: book
bibliography:
- book.bib
- packages.bib
cover-image: F1_book_cover.PNG
description: "This is a book documenting data visualizations of Formula 1 data.  \n"
link-citations: yes
github-repo: casanscott/vizf1book
site: bookdown::bookdown_site
---




# About the book


This is a book for anyone that finds themselves located within the fairly obscure intersection of the *data enthusiast-Formula 1 fan* Venn diagram (see Figure below: [1.9 Data Visualization](#Data Visualization))). The overarching goal of the book is to provide a gentle introduction to analyzing Formula 1 data using the R programming language. It includes some brief commentary on the sport of Formula 1, lots of data visualizations, and R code used to create each plot. While this book is *primarily* written for people interested in data visualization using the R programming language, I do hope that some of the nerdier Formula 1 fans will find these data visualizations interesting.


\newpage



## Cover Art

<br>

```{r, echo = F, out.width= "90%", out.height= "90%", fig.show = 'hold', fig.align='center'}
knitr::include_graphics('F1_book_cover.PNG')
```

\newpage
<br>
<br>

The cover art is the work of Alison Gaspard. Alison is a tattoo artist, BFA in studio art,  and former Visual Arts/Art History educator located in Houston, Texas. 

You can find Alison here: https://www.alisonlenayfineart.com/


## About me

TLDR: Casan Scott, Ph.D., Senior Data Scientist

More information: I am a bit of a nomad, professionally. Academically, I graduated with B.S. and Ph.D. degrees in environmental science and my Ph.D. research focused on the toxicology of fish. Naturally, I decided to *not* use my doctorate degree and became a data scientist! I fell in love with the R programming language during graduate school, and decided I would rather *analyze* data than *collect* it. Over the past five years, I've worked as a data scientist in both the public and private sectors. At times, I also contribute to research on human performance topics. Outside of my nerdier professional pursuits, I enjoy competing in powerlifting, trail running, reading westerns, and hanging out with my wife and dogs. 


## Why did I write this book? 

To scratch my own itch *per se*. Formula 1 is actually a very complicated sport, and while learning about it I had lots of questions: *Do practice times mean anything? Does the qualifying time predict race pace? How much do the cars improve each year? Why is Red Bull so good in Mexico City?* Of course, there were plenty of answers to these questions online, but I really wanted to try and answer some of these questions myself. So, this book documents my attempt at doing so. Along the way, I include the code to create each plot and some brief annotations about the functions used. 


## Organization of this book 

I aimed to loosely organize this book like a typical Formula 1 weekend: (1) practice data, (2) qualifying data , and (3) results from the Grand Prix. For the most part, I try to summarize the historical data, visualize possible trends in the data, explore important differences, plot potential correlations, and perhaps build a model that can explain some relationship(s) that seems interesting. Along the way, I may pursue a tangent or two. Each chapter begins with a racing-centric introduction, followed by various analyses. The organization of chapters in this book are as follows:

* Chapter 2: Introduction to Formula 1
    + An introduction to Formula 1 racing and the sessions in a weekend
    + Pulling data using the drs package
    + Basic visualizations of practice data
* Chapter 3: Qualifying
    + Plotting distributions of qualifying data
    + Visualizing qualifying times over time
* Chapter 4: Relating practice times to qualifying times
    + Simple linear regression models
    + Confidence intervals
    + Interactions
* Chapter 5: Drivers
    + Using heatmaps to visualize race results for drivers
    + Comparisons between teammates
* Chapter 6: Race Results
    + Starting position vs Final Placing
    + Ordinal regression models
    + Plotting ordinal regression results
* Chapter 7: DNFs
    + Rates of DNFs (Did not finish)
    + Logistic regression models 
    + Interpreting logistic regression models
* Chapter 8: Champions
    + Visualizing championship fights 




## R

R is a programming language that is largely used for statistical analysis and data visualization. One of R's biggest strengths is the ease with which high quality data visualizations can be be produced. This feature is what drew me to the language back in 2013, and is the reason that I am able to write this book!

For information on R, visit this link: https://www.r-project.org/about.html

## ggplot2

I am assuming that you have some experience using the R programming language. If you have never used R before, you will quickly become very confused! This entire book is based on the **ggplot2** package in R. **ggplot2** is a package used for producing statistical and other data graphics. What makes **ggplot2** unique is it has an underlying *grammar*, based on the *Grammar of Graphics* (Wilkinson 2005). This attribute allows you to create graphs by combining independent components to suit your particular problem. That may seem like a trivial distinction, but it makes **ggplot2** very powerful! 

Note: At times, I may refer to **ggplot2** as simply **ggplot**. If that is annoying... apologies in advance!

## The *tidyverse*

Throughout this book, I rely on the **tidyverse**. The **tidyverse** is actually a collection of other packages that share common data representations and design structures. This enables these packages to work together *very* conveniently. For instance, I nearly always use functions from the **dplyr** package to wrangle data prior to plotting with **ggplot2**. You can install the **tidyverse** core packages with a single command:

```
# Install the package from CRAN
install.packages("tidyverse")

# Load the package
library(tidyverse)
```

The core pakcages in **tidyverse** are:

* **ggplot2**, for data visualization.
* **dplyr**, for data manipulation.
* **tidyr**, for data tidying.
* **readr**, for data import.
* **purrr**, for functional programming.
* **tibble**, for tibbles, a modern re-imagining of data frames.
* **stringr**, for strings.
* **forcats**, for factors.
* **lubridate**, for date/times.


Aside from **ggplot2**, I most heavily use **dplyr** in this book. There are six key **dplyr** functions that can solve most data manipulation challenges:

* `select()`: subset columns from a dataframe. In other words, you use this to choose variables by name. 
* `filter()`: filter the dataframe by values of a variable. This can be both numeric (i.e. age > 21 years) or categorical (i.e. month == June). 
* `arrange()`: order the rows of the dataframe 
* `mutate()`: create a new variable
* `summarize()`: collapse values down to a summarized metric (i.e. mean, minimum, maximum). 
* `group_by()`: operates any of the previous functions on a group basis (i.e. a grouped mean).


I highly recommend this book chapter for more information on **dplyr** basics:

https://r4ds.had.co.nz/transform.html


For a thorough introduction to the **tidyverse**, read the entire fantastic book:

https://r4ds.had.co.nz/index.html


## Data

<img src="drs_logo.png" align="right" height="212" alt="" />

<br />
<br />

The data used in this book was pulled from formula1.com. To make it easier for readers to use this data, I developed the **drs** (**D**ata for **R**acing **S**imulations) R package. If you currently follow Formula 1, you will recognize that DRS also stands for *Drag Reduction System*, which is a crucial component of Formula 1 cars that opens space in the rear wing thereby reducing drag. The **drs** R package utilizes functions from the **rvest** and **dplyr** packages to scrape and tidy data from the formula1.com website. It is designed to scrape data for all Grand Prix weekends during a given year. Each function returns a dataframe that you can then use for analysis and visualizations. 

<br />


:::: {.blackbox data-latex=""}
::: {.center data-latex=""}
**Notes about a Formula 1 Grand Prix Weekend**
:::

A Grand Prix weekend consists of practice sessions, qualifying, and a race. Additionally, some weekends will also include a sprint race (an abbreviated sprint race that is typically about 1/3 the length of a normal race). A typical Formula 1 weekend begins with three practice sessions. The first two practice sessions (FP1 and FP2) are held on Friday. On Saturday, the third practice session (FP3) is held, followed by Qualifying. Qualifying determines the grid for the race on Sunday. Currently, there are three heats in qualifying (Q1, Q2, and Q3). All cars compete in the first heat (*Q1*), and the top 15 fastest times advance to the 2nd heat, *Q2*. From there, the top 10 fastest times during heat 2 advance to *Q3* (heat 3). The starting grid is determined by a driver's final qualifying position (pending penalties). The race takes place on Sunday. 

::::


<br />


**drs** currently consists of four scraping functions:

* `practice_session_scraper()`: Scrapes the best times for a given practice session. 
* `qualifying_scraper()`: Scrapes the best qualifying times during Q1, Q2, and Q3. 
* `starting_grid_scraper()`: Scrapes the final starting grid positions for the Grand Prix. 
* `race_result_scraper()()`: Scrapes the race results for a Grand Prix (i.e. finishing position and total time). 


#### Installation of drs

You can install the development version of **drs** here:

``` r
install_github("casanscott/drs")
```

#### Using the drs package

These functions from **drs** require both the **tidyverse** and **rvest** packages. The `practice_session_scraper()` requires two arguments: `year` and `practice_session_number`. After loading those libraries, along with **drs**, you can easily scrape data using a function call like this: 

```{r example practice, warning = F, message= F}
library(tidyverse)
library(rvest)
library(drs)

# pull FP3 practice data
p32022 <- practice_session_scraper(2022, 3)

# View the first 6 rows
head(p32022)
```



The rest of the **drs** web scraping functions require a single argument: `year`. 

The following function will scrape all qualifying results from 2022: 

```{r example qualifying, warning = F, message= F}

# pull qualifying data
quali2022 <- qualifying_scraper(2022)

# View the first 6 rows
head(quali2022)
```


To scrape the starting grids for every Grand Prix during 2022, use the following function call:

```{r example starting grid, warning = F, message= F}

# pull starting grids
grids2022 <- starting_grid_scraper(2022)

# View the first 6 rows
head(grids2022)
```



To scrape the race results for every Grand Prix during 2022, use the following function call:

```{r example race results, warning= F, message= F}

# Pull race results
races2022 <- race_result_scraper(2022)

# View the first 6 rows
head(races2022)
```


You can then use these dataframes to create cool data visualizations like this one:



```{r, echo = F, warning = F, message = F, fig.align = 'center', fig.height = 5, fig.width = 6}
library(ggthemes)


races2022 %>%
  mutate( n = 1:n(),
          Race = fct_reorder(Race, desc(n))) %>%
  group_by(Race) %>% 
  mutate(Race_number = cur_group_id()) %>%
  group_by(Driver) %>% 
  mutate(sum_pts = sum(Points, na.rm = T)) %>%
  ungroup() %>% 
  ggplot(aes(fct_reorder(Driver, desc(sum_pts)), Race, fill = Points)) +
  geom_tile(color="white", size=0.1, alpha = 0.75) +
  theme_bw() +
  labs(title = 'Points scored during the 2022 season',
       y = 'Race',
       x = 'Driver') + 
  theme_tufte(base_family="Helvetica")  +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position="bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_viridis_c(option = 'magma',
                       guide = 'legend',
                       breaks = c(0,1,2,4,6,8,10,12,15,18,25,26))
```




## Data Visualization

In addition to commentary about Formula 1 racing, I'll also include brief instructions about how to create the data visualizations in this book. For example, use this chunk of code...


```{r, message=F, warning= F, eval=FALSE}
library(ggvenn)
library(ggplot2)

x <- list(`Formula 1 fan` = rep('This book!', 1),
          `Data enthusiast` = rep('This book!', 1))


ggvenn(
  x, 
  show_elements = T,
  show_percentage = F,
  fill_color = c("#CD534CFF", "#0073C2FF"),
  stroke_size = 0.5, stroke_alpha = 0.5, set_name_size = 4
  )

```

... to create this figure:


```{r, echo = F, message=F, warning= F, fig.align='center'}
library(ggvenn)
library(ggplot2)

x <- list(`Formula 1 fan` = rep('This book!', 1),
          `Data enthusiast` = rep('This book!', 1))


ggvenn(
  x, 
  show_elements = T,
  show_percentage = F,
  fill_color = c("#CD534CFF", "#0073C2FF"),
  stroke_size = 0.5, stroke_alpha = 0.5, set_name_size = 4
  )

```


I'll also occasionally include shaded boxes with supplemental information about a particular chart type, an interesting R package, or anything else that seems noteworthy. For example, the following shaded box includes additional information on the R package used to create the Venn diagram (**ggvenn**): 

:::: {.blackbox data-latex=""}
::: {.center data-latex=""}
**How to create a Venn diagram in R**
:::

I used the **ggvenn** and **ggplot2** packages to create this simple Venn diagram. The **ggvenn** package was created by Linlin Yan. In my opinion, **ggvenn** is the easiest way to create simple Venn diagrams that follow the typical **ggplot2** styling and syntax. 

For more information about the **ggvenn** package, visit this link: https://cran.r-project.org/web/packages/ggvenn/index.html

If you've never used **ggplot2** before (boy, are you in for a treat!), check out this link to the **ggplot** book written by legends of the tidyverse Hadley Wickham, Danielle Navarro, and Thomas Lin Pedersen: https://ggplot2-book.org/

::::


In the next chapter, we will dive into Formula 1 data. I'll start with a gentle introduction to Formula 1 and a typical Grand Prix weekend. 

\newpage
